sudo: required
git:
  depth: 3

language: node_js
node_js:
  - "10"

install:
  - if [ $COMPONENT = ppx ]; then wget https://raw.githubusercontent.com/ocaml/ocaml-ci-scripts/master/.travis-ocaml.sh; fi
  - if [ $COMPONENT = ppx ]; then bash -ex .travis-ocaml.sh; fi
  - if [ $COMPONENT = ppx ]; then opam pin -y -n add sedlex .; fi
  - if [ $COMPONENT = ppx ]; then opam install -y --deps-only sedlex; fi
  - if [ $COMPONENT = ppx ]; then eval `opam config env`; fi
  - if [ $COMPONENT = ppx ]; then opam config env; opam list; fi

  - if [ $COMPONENT = runtime ]; then npm ci --ignore-scripts; fi
  - if [ $COMPONENT = runtime ]; then npm install bs-platform; fi

script: npm run build:$COMPONENT

jobs:
  fast_finish: true
  allow_failures:
    - os: osx
      env: COMPONENT=ppx
  include:
    - stage: deploy
      script: npm run build:ppx
      deploy:
        provider: releases
        skip_cleanup: true
        api_key:
          secure: ah4e4jsAB2BWpsO+AwFdgd2Wt79S+f8qb79vzFbOBWysvnMgOMv2i0/+vPppG2h/NA40Ml8nIZ4akEwUxuFujSVoZQzZf3CFToSA5JF3i/nWXymJJD2PkFpmFHOKQHk9z3XJzsAYXhxOd4Is7UrbYkoFXM0lUac80dOnngR3PFLi4bKPhdowOTwPoizQiSitwv6lZvWgX7XS7QkIUY0dh/GIsA0sHCoIMj6K+H2oKV2D7K93LtD4beri4JN/F02KJznBjF7OhqOg+iVD09n+g7lGTOu8S3kfeJpYjybODoApzdLlgFOgs5JF8iKYQXLwEpeliadfcOmr0/Kc0XlDX733N4FfWuZiFCm0Erk5b0rTAzmHg05WlADXL1i17A1sSg7H7SpTskPL57WmijdPHgmKwHRh5F/tUa8qksMkkbYMi3G9oq+azKJotxrU4dEs58oTYOghWrM0F3oyW2H0d0CCpBbT8HSoEJcUQq6i+n9pyEvmu1OASt/HUkW0gULm9HgSYwVDTo19Xx4Wubtcc7f1BlrkN3FMrPpLEuJWavbLKJ3ilpCASo6THbADLzfwib4lrsmuMu5LaL5ytEP9U2x1xXIV1y/OHTWnQfAY2MFHa6va1J3cCXrrKM0T7fjhIr47csKzPE7X33X7ZtVlcRwRuZ/nhQkWPUCRkdwpFus=
        file_glob: true
        file: dist/*
        on:
          tags: true

env:
  global:
    - OCAML_VERSION=4.02
    - OPAM_SWITCH=4.02.3+buckle-master
  matrix:
    - COMPONENT=ppx
    - COMPONENT=runtime
os:
  - linux
  - osx
